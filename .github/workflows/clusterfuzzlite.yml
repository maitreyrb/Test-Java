name: ClusterFuzzLite PR Fuzzing

on:
  pull_request:

jobs:
  clusterfuzzlite:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm cmake ninja-build \
                                  libprotobuf-dev protobuf-compiler \
                                  python3 python3-pip

      - name: Checkout ClusterFuzzLite
        run: |
          git clone https://github.com/google/clusterfuzzlite.git

      # ðŸ”¨ BUILD FUZZERS (THIS IS PROJECT-SPECIFIC)
      - name: Build fuzz targets with sanitizers
        env:
          CC: clang
          CXX: clang++
          CFLAGS: "-fsanitize=address,undefined -fno-omit-frame-pointer"
          CXXFLAGS: "-fsanitize=address,undefined -fno-omit-frame-pointer"
        run: |
          mkdir -p build
          cd build
          cmake -GNinja ..
          ninja

      # ðŸš€ RUN CLUSTERFUZZLITE IN PR MODE
      - name: Run ClusterFuzzLite (code change / PR mode)
        env:
          MODE: code_change
        run: |
          python3 clusterfuzzlite/run.py
