name: ClusterFuzzLite PR Fuzzing

on:
  pull_request:

jobs:
  fuzz:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang llvm cmake ninja-build \
            python3 python3-pip \
            libprotobuf-dev protobuf-compiler

      # ❌ DO NOT pip install clusterfuzzlite
      # ✅ Clone it instead
      - name: Checkout ClusterFuzzLite
        run: |
          git clone https://github.com/google/clusterfuzzlite.git

      - name: Build fuzz targets (example)
        env:
          CC: clang
          CXX: clang++
          CFLAGS: "-fsanitize=address,undefined -fno-omit-frame-pointer"
          CXXFLAGS: "-fsanitize=address,undefined -fno-omit-frame-pointer"
        run: |
          mkdir -p build
          cd build
          cmake -GNinja ..
          ninja

      - name: Run ClusterFuzzLite (PR mode)
        env:
          MODE: code_change
        run: |
          python3 clusterfuzzlite/run.py


